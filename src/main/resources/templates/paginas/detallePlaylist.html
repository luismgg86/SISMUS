<!-- templates/playlists/detallePlaylist.html -->
<div xmlns:th="http://www.thymeleaf.org" th:fragment="fragment" class="text-white">

    <!-- Encabezado Playlist -->
    <div class="d-flex align-items-center mb-4">
        <img th:src="@{/images/default_playlist.jpg}"
             class="rounded me-3 img-fluid"
             style="width: 120px; height: 120px; object-fit: cover;"
             alt="Imagen Playlist">

        <div>
            <h2 class="mb-1 text-white" th:text="${playlist.nombre}">Nombre Playlist</h2>
            <p class="text-light mb-0">
                Creada el <span th:text="${#temporals.format(playlist.fechaCreacion, 'dd/MM/yyyy')}">15/04/2025</span>
            </p>
            <p class="text-light small">
                Total de canciones: <span th:text="${#lists.size(playlist.canciones)}">0</span>
            </p>
        </div>
    </div>

    <!-- Tabla de canciones -->
    <div class="table-responsive">
        <table class="table table-dark table-hover align-middle">
            <thead>
            <tr class="text-white">
                <th scope="col" class="text-center">#</th>
                <th scope="col">Título</th>
                <th scope="col">Fecha agregada</th>
                <!-- Encabezado Duración -->
                <th scope="col" class="text-end">Duración <i class="bi bi-clock ms-1"></i></th>
            </tr>
            </thead>
            <tbody>
            <tr class="cancion-row"
                th:each="cancion, iterStat : ${playlist.canciones}"
                th:data-id="${cancion.id}">
                <!-- Número -->
                <td class="text-center text-light" th:text="${iterStat.index + 1}">1</td>

                <!-- Imagen + Título + Artista -->
                <td>
                    <div class="d-flex align-items-center">
                        <img th:src="@{/images/default.jpg}"
                             class="rounded me-3"
                             style="width: 45px; height: 45px; object-fit: cover;"
                             alt="Cover">
                        <div>
                            <div class="fw-bold text-white" th:text="${cancion.titulo}">Título Canción</div>
                            <small class="text-light" th:text="${cancion.artista.nombre}">Artista</small>
                        </div>
                    </div>
                </td>

                <!-- Fecha agregada (dummy por ahora) -->
                <td class="text-light">Hace 1 semana</td>

                <!-- Duración: segundos → mm:ss -->
                <td class="text-end text-light">
                    <span th:text="${cancion.duracion != null
                                    ? ((cancion.duracion / 60) + ':' + #numbers.formatInteger(cancion.duracion % 60, 2))
                                    : '0:00'}">0:00</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Menú contextual flotante -->
    <div id="contextMenu"
         class="dropdown-menu bg-dark text-white"
         style="position: absolute; display: none; z-index: 1050;">
        <form id="deleteForm" method="post" th:action="@{'/playlists/' + ${playlist.id} + '/eliminar-cancion'}">
            <input type="hidden" name="cancionId" id="cancionId">
            <button type="submit" class="dropdown-item text-danger">
                <i class="bi bi-trash"></i> Eliminar canción
            </button>
        </form>
    </div>

    <div class="mt-4">
        <h5 class="text-white">Agregar canción</h5>
        <form th:action="@{'/playlists/' + ${playlist.id} + '/agregar-cancion'}" method="post" class="row g-2">
            <div class="col-md-8">
                <select name="cancionId" class="form-select bg-dark text-white border-secondary" required>
                    <option value="" disabled selected>Selecciona una canción</option>
                    <option th:each="cancion : ${cancionesDisponibles}"
                            th:value="${cancion.id}"
                            th:text="${cancion.titulo + ' - ' + cancion.artista.nombre}">
                    </option>
                </select>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-success w-100">Agregar</button>
            </div>
        </form>
    </div>

    <script>
        console.log("Script de detalle playlist cargado correctamente");

        document.addEventListener('DOMContentLoaded', function () {
            const rows = document.querySelectorAll('.cancion-row');
            const contextMenu = document.getElementById('contextMenu');
            const deleteInput = document.getElementById('cancionId');

            rows.forEach(row => {
                row.addEventListener('contextmenu', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const cancionId = row.getAttribute('data-id');
                    deleteInput.value = cancionId;

                    contextMenu.style.top = e.pageY + 'px';
                    contextMenu.style.left = e.pageX + 'px';
                    contextMenu.style.display = 'block';
                });
            });

            document.addEventListener('click', function () {
                contextMenu.style.display = 'none';
            });

            window.addEventListener('resize', () => contextMenu.style.display = 'none');
            window.addEventListener('scroll', () => contextMenu.style.display = 'none');
        });
    </script>

</div>
