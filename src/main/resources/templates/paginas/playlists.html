<div xmlns:th="http://www.thymeleaf.org" th:fragment="fragment">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Tus Playlists</h3>
        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#crearPlaylistModal">
            <i class="bi bi-plus-lg"></i> Nueva Playlist
        </button>
    </div>

    <p th:if="${#lists.isEmpty(playlists)}" class="text-center text-secondary">
        No tienes playlists creadas todav√≠a.
    </p>

    <div class="row g-3" th:if="${!#lists.isEmpty(playlists)}">
        <div class="col-6 col-md-3" th:each="playlist : ${playlists}">
            <div class="card h-100 playlist-card"
                 th:attr="data-playlist-id=${playlist.id},data-playlist-name=${playlist.nombre}">
                <img th:src="@{/images/default_playlist.jpg}" class="card-img-top" alt="Imagen de Playlist">

                <div class="card-body">
                    <h6 class="card-title text-white mb-2" th:text="${playlist.nombre}">Nombre Playlist</h6>
                    <p class="card-text text-secondary small mb-2">
                        Creada el
                        <span th:text="${#temporals.format(playlist.fechaCreacion, 'dd/MM/yyyy')}">01/01/2025</span>
                    </p>
                    <small class="text-secondary">
                        Canciones: <span th:text="${#lists.size(playlist.canciones)}">0</span>
                    </small>
                </div>

                <div class="card-footer text-center">
                    <a th:href="@{'/playlists/' + ${playlist.id}}" class="btn btn-sm btn-outline-light">
                        Ver Detalles
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Crear Playlist -->
    <div class="modal fade" id="crearPlaylistModal" tabindex="-1" aria-labelledby="crearPlaylistModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="crearPlaylistModalLabel">Crear Nueva Playlist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/playlists/crear}" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre de la Playlist</label>
                            <input type="text" id="nombre" name="nombre" class="form-control bg-dark text-white border-secondary" placeholder="Ejemplo: M√∫sica para Estudiar" required>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Crear</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Men√∫ contextual (igual que en Canciones, pero con otro id) -->
    <style>
        /* Igual que el de Canciones, solo cambiamos a position:fixed para clavar al viewport */
        #playlistContextMenu {
            position: fixed;                 /* clave para que no ‚Äúse vaya al fondo‚Äù */
            display: none;
            background-color: #181818;
            border: 1px solid #333;
            border-radius: 8px;
            z-index: 2050;                   /* por encima del player */
            min-width: 200px;
            padding: 6px 0;
        }
        #playlistContextMenu a {
            display: block;
            padding: 10px;
            color: #b3b3b3;
            text-decoration: none;
            font-size: 0.95rem;
        }
        #playlistContextMenu a:hover {
            background-color: #282828;
            color: #fff;
        }
    </style>

    <div id="playlistContextMenu">
        <a href="#" id="deletePlaylistAction">üóë Eliminar Playlist</a>
    </div>

    <!-- Modal Confirmaci√≥n -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Eliminar Playlist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ¬øEst√°s seguro de eliminar <strong id="playlistNameToDelete"></strong>?
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS (mismo patr√≥n que Canciones con jQuery) -->
    <script th:src="@{/bootstrap/js/jquery-3.6.3.js}"></script>
    <script th:src="@{/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script>
        $(function () {
            const $menu = $("#playlistContextMenu");
            const $nameHolder = $("#playlistNameToDelete");
            const deleteModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));

            let selectedId = null;
            let selectedName = null;

            $(document).on("contextmenu", ".playlist-card", function (e) {
                e.preventDefault();

                selectedId = $(this).attr("data-playlist-id");
                selectedName = $(this).attr("data-playlist-name");

                const menuW = $menu.outerWidth() || 200;
                const menuH = $menu.outerHeight() || 44;
                const vw = $(window).width();
                const vh = $(window).height();

                let x = e.clientX;
                let y = e.clientY;
                if (x + menuW > vw) x = vw - menuW - 8;
                if (y + menuH > vh) y = vh - menuH - 8;

                $menu.css({ left: x + "px", top: y + "px" }).fadeIn(150);
            });

            $(document).on("click scroll resize", function () {
                $menu.fadeOut(100);
            });

            $("#deletePlaylistAction").on("click", function (e) {
                e.preventDefault();
                $menu.hide();
                $nameHolder.text(selectedName);
                deleteModal.show();
            });

            $("#confirmDeleteBtn").on("click", function () {
                $.ajax({
                    url: "/playlists/" + selectedId + "/eliminar",
                    type: "DELETE",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    success: function () {
                        deleteModal.hide();
                        $(".playlist-card[data-playlist-id='" + selectedId + "']").closest(".col-6, .col-md-3").remove();
                        // location.reload();
                    },
                    error: function () {
                        deleteModal.hide();
                        alert("Error al eliminar la playlist");
                    }
                });
            });
        });
    </script>
</div>
